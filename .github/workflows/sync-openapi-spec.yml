name: Sync OpenAPI Spec

on:
  # Trigger after a release is published
  release:
    types: [published]
  # Manual trigger for ad-hoc sync
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (skip pushing to API repo)'
        type: boolean
        default: false

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always

jobs:
  sync-spec:
    name: Export & Sync OpenAPI Spec
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout backend
        uses: actions/checkout@v6

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - name: Install protoc
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

      - name: Build backend
        env:
          SQLX_OFFLINE: true
        run: cargo build --release

      - name: Export OpenAPI spec
        run: |
          # Start backend briefly to export the spec
          export DATABASE_URL="postgresql://unused:unused@localhost/unused"
          export JWT_SECRET="ci-export-only"
          export STORAGE_PATH="/tmp/ak-storage"
          export BIND_ADDRESS="127.0.0.1:18080"
          mkdir -p /tmp/ak-storage

          # The spec is built at startup, we just need to GET it
          ./target/release/artifact-keeper &
          SERVER_PID=$!

          # Wait for server to start (it will fail DB connection but spec is served before that)
          for i in $(seq 1 30); do
            if curl -sf http://127.0.0.1:18080/api/v1/openapi.json -o /dev/null 2>/dev/null; then
              break
            fi
            sleep 1
          done

          # Export spec
          curl -sf http://127.0.0.1:18080/api/v1/openapi.json | python3 -m json.tool > openapi.json
          python3 -c "
          import json, sys
          try:
              import yaml
              with open('openapi.json') as f:
                  spec = json.load(f)
              with open('openapi.yaml', 'w') as f:
                  yaml.dump(spec, f, default_flow_style=False, sort_keys=False, allow_unicode=True)
          except ImportError:
              print('PyYAML not available, installing...')
              sys.exit(1)
          "
          if [ $? -ne 0 ]; then
            pip3 install pyyaml
            python3 -c "
          import json, yaml
          with open('openapi.json') as f:
              spec = json.load(f)
          with open('openapi.yaml', 'w') as f:
              yaml.dump(spec, f, default_flow_style=False, sort_keys=False, allow_unicode=True)
          "
          fi

          kill $SERVER_PID 2>/dev/null || true

          echo "## Exported spec summary" >> $GITHUB_STEP_SUMMARY
          echo "- Paths: $(python3 -c "import json; print(len(json.load(open('openapi.json'))['paths']))")" >> $GITHUB_STEP_SUMMARY
          echo "- Schemas: $(python3 -c "import json; print(len(json.load(open('openapi.json')).get('components',{}).get('schemas',{})))")" >> $GITHUB_STEP_SUMMARY

      - name: Upload spec artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openapi-spec
          path: |
            openapi.json
            openapi.yaml

      - name: Push spec to API repo
        if: ${{ !inputs.dry_run }}
        env:
          DEPLOY_KEY: ${{ secrets.API_REPO_DEPLOY_KEY }}
        run: |
          VERSION="${{ github.event.release.tag_name || 'manual' }}"

          # Set up SSH deploy key
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/api-repo-deploy
          chmod 600 ~/.ssh/api-repo-deploy
          ssh-keyscan github.com >> ~/.ssh/known_hosts 2>/dev/null
          export GIT_SSH_COMMAND="ssh -i ~/.ssh/api-repo-deploy -o IdentitiesOnly=yes"

          git clone git@github.com:artifact-keeper/artifact-keeper-api.git /tmp/api-repo

          cp openapi.json /tmp/api-repo/openapi.json
          cp openapi.yaml /tmp/api-repo/openapi.yaml

          cd /tmp/api-repo
          if git diff --quiet; then
            echo "No spec changes detected"
          else
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add openapi.json openapi.yaml
            git commit -m "chore: sync OpenAPI spec from backend ${VERSION}"
            git push origin main
          fi

          # Clean up key
          rm -f ~/.ssh/api-repo-deploy
